{% extends 'layout.html' %}

{% block title %}
- Crear reporte
{% endblock %}


{% block content %}

<div class="container-fluid flex-grow-1 py-2">
    <form action="{{ url_for('reportes.crear_reporte') }}" method="post">
        <h2>Nuevo reporte</h2>
        <fieldset>
            <legend>Solicitante</legend>
            <ul class="list-unstyled row g-2">
                <li class="col">
                    <label for="nombre-sol" class="form-label">Nombre:</label>
                    <input type="text" name="nombre-sol" id="nombre-sol" class="form-control" placeholder="María">
                </li>
                <li class="col">
                    <label for="apellido-sol" class="form-label">Apellido:</label>
                    <input type="text" name="apellido-sol" id="apellido-sol" class="form-control" placeholder="Morales">
                </li>
            </ul>
        </fieldset>
        <fieldset id="ubicacion-fieldset">
            <legend>Ubicación</legend>
            <ul class="list-unstyled row g-2 align-items-end">
                <li class="col-6">
                    <!-- <label for="tipo-area" class="form-label">Área:</label> -->
                    <select name="tipo-area" id="tipo-area" class="form-select">
                        <option value="" selected>Selecciona un área</option>
                        {% for tipo in areas['tipos'] %}
                        <option value="{{ tipo }}">{{ tipo|capitalize }}</option>
                        {% endfor %}
                    </select>
                </li>
                <li class="col-6">
                    <!-- <label for="nombre-area" class="form-label">:</label> -->

                    <!-- Todas las areas juntas -->

                    <select name="nombre-area" id="nombre-area" class="form-select">
                        <option value="" selected>Selecciona tu área de trabajo</option>
                        {% for tipo, tipo_areas in areas['nombres'].items() %}
                        {% if tipo_areas %}
                        <optgroup label="{{ tipo | capitalize }}">
                            {% for area in tipo_areas %}
                            <option value="{{ area }}">{{ tipo | capitalize }} de {{ area['nombre'] | capitalize }}
                            </option>
                            {% endfor %}
                        </optgroup>
                        {% endif %}
                        {% endfor %}
                    </select>

                </li>
                <li class="col-4 row align-items-center mt-3">
                    <label for="torre" class="col-auto form-label m-0">Torre:</label>
                    <select name="torre" id="torre" class="col form-select">
                        <option value="" selected>Seleccionar torre</option>
                        <option value="a">A</option>
                        <option value="b">B</option>
                        <option value="c">C</option>
                        <option value="d">D</option>
                        <option value="e">E</option>
                        <option value="f">F</option>
                    </select>
                </li>
                <li class="col-4 row align-items-center mt-3">
                    <label for="piso" class="col-auto form-label m-0">Piso:</label>
                    <select name="piso" id="piso" class="col form-select">
                        <option value="" selected>Seleccionar piso</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="0">Planta baja</option>
                    </select>
                </li>
                <li class="col-4 row align-items-center mt-3">
                    <label for="ext-telefonica" class="col-auto form-label m-0">Ext. telefónica:</label>
                    <input type="text" name="ext-telefonica" id="ext-telefonica" class="col form-control"
                        placeholder="3311">
                </li>
            </ul>
        </fieldset>
        <fieldset>
            <legend>Descripción del equipo</legend>
            <ul class="list-unstyled row g-2">
                <li class="col-6">
                    <label for="tipo-dispositivo" class="form-label">Tipo de dispositivo:</label>
                    <select name="tipo-dispositivo" id="tipo-dispositivo" class="form-select">
                        <option selected>Selecciona un tipo de dispositivo</option>
                        <option value="2">Monitor</option>
                        <option value="1">Raton</option>
                        <option value="3">Teclado</option>
                        <option value="3">CPU</option>
                        <option value="3">Impresora</option>
                    </select>
                </li>
                <li class="col-6">
                    <label for="cod-bienes" class="form-label">Chapa ULA:</label>
                    <input type="text" name="cod-bienes" id="cod-bienes" class="form-control"
                        placeholder="2-80124-34011">
                </li>
                <li class="col">
                    <label for="falla" class="form-label">Falla:</label>
                    <select name="falla" id="falla" class="form-select">
                        <option selected>Selecciona una falla</option>
                        <option value="2">No enciende</option>
                        <option value="1">Se apaga</option>
                        <option value="3">Se queda pegada</option>
                        <option value="3">Monitor no muestra imagen</option>
                    </select>
                </li>
                <li class="col-12">
                    <label for="fecha-visita" class="form-label me-3">Fecha disponible para visita:</label>
                    <input type="datetime-local" name="fecha-visita" id="fecha-visita" class="p-2">
                    <div class="form-text">Selecciona una fecha y hora que te convenga para que uno de nuestros técnicos
                        de soporte visite tu área de trabajo</div>
                </li>
            </ul>
        </fieldset>
        <button type="submit" class="btn btn-primary w-100">Crear reporte</button>
    </form>
</div>
<script>
    const SCRIPT_ROOT = {{ url_for("departamentos.query") | tojson }}
    // const SCRIPT_ROOT = {{ request.script_root|tojson }}
    console.log(SCRIPT_ROOT)

    const camposUbicacion = document.querySelector('#ubicacion-fieldset > ul');
    const tipoArea = camposUbicacion.querySelector('#tipo-area');
    const defAreaSelect = camposUbicacion.querySelector('#nombre-area');
    const torreArea = camposUbicacion.querySelector('#torre');
    const pisoArea = camposUbicacion.querySelector('#piso');

    const selects = camposUbicacion.querySelectorAll('select');
    selects.forEach(select => {
        if (select.id == 'nombre-area') return;

        select.addEventListener('change', async () => {
            const torre = torreArea.value || 'none';
            const piso = pisoArea.value || 'none';
            const tipo = tipoArea.value || 'none';

            if (torre == 'none' && piso == 'none' && tipo == 'none') {
                const areaSelect = camposUbicacion.querySelector('#nombre-area');
                areaSelect.replaceWith(defAreaSelect)
                return
            }

            // const url = `${SCRIPT_ROOT}/${torre}/${piso}/${tipo}`;
            const url = `${SCRIPT_ROOT}?torre=${torre}&piso=${piso}&tipo=${tipo}`;

            console.log('fetching url: ' + url)
            const deps_consulta = await fetch(url);
            const deps_json = await deps_consulta.json()

            console.log(deps_json)
            console.log('it works?')

            const newAreaSelect = document.createElement('select');
            newAreaSelect.id = 'nombre-area'
            newAreaSelect.name = 'nombre-area'
            newAreaSelect.classList.add('form-select')
            for (const area of deps_json) {
                const areaOpt = document.createElement('option');
                areaOpt.value = area.nombre;
                areaOpt.textContent = area.nombre;

                newAreaSelect.appendChild(areaOpt);
            }

            const areaSelect = camposUbicacion.querySelector('#nombre-area');
            areaSelect.replaceWith(newAreaSelect)
        })
    })
</script>
{% endblock %}